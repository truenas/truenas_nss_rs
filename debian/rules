#!/usr/bin/make -f

# See debhelper(7) (uncomment to enable)
# output every command that modifies files on the build system.
export DH_VERBOSE = 1

# see FEATURE AREAS in dpkg-buildflags(1)
export DEB_BUILD_MAINT_OPTIONS = hardening=+all

# see ENVIRONMENT in dpkg-buildflags(1)
# package maintainers to append CFLAGS
export DEB_CFLAGS_MAINT_APPEND  = -Wall -pedantic
# package maintainers to append CPPFLAGS
export DEB_CPPFLAGS_MAINT_APPEND = -D_FORTIFY_SOURCE=2
# package maintainers to append LDFLAGS
export DEB_LDFLAGS_MAINT_APPEND = -Wl,--as-needed

# Cargo configuration
export CARGO_HOME = $(CURDIR)/debian/cargo_home

%:
	dh $@

override_dh_auto_configure:
	# Initialize cargo home
	mkdir -p $(CARGO_HOME)

override_dh_auto_build:
	# Build the library in release mode
	cargo build --release --lib
	# Build benchmarks (optional, for completeness)
	cargo build --release --benches
	# Create Python virtual environment and install maturin
	python3 -m venv debian/python-build-env
	. debian/python-build-env/bin/activate && pip install --upgrade pip maturin
	# Build Python wheel
	. debian/python-build-env/bin/activate && maturin build --release --features python --out target/wheels/

override_dh_auto_test:
	# Run tests
	cargo test --release

override_dh_auto_install:
	# Install Rust library file for development
	install -D -m 644 target/release/libtruenas_rust_nss.rlib \
		$(CURDIR)/debian/libtruenas-rust-nss-dev/usr/lib/rust/libtruenas_rust_nss.rlib
	# Install Rust source for development package
	mkdir -p $(CURDIR)/debian/librust-truenas-nss-dev/usr/share/cargo/registry/truenas-nss-0.1.0
	cp -r src/ Cargo.toml LICENSE README.md $(CURDIR)/debian/librust-truenas-nss-dev/usr/share/cargo/registry/truenas-nss-0.1.0/
	# Generate .cargo-checksum.json
	cd $(CURDIR)/debian/librust-truenas-nss-dev/usr/share/cargo/registry/truenas-nss-0.1.0 && \
	echo '{"files":{},"package":""}' > .cargo-checksum.json
	# Install Python wheel
	. debian/python-build-env/bin/activate && pip install --target $(CURDIR)/debian/python3-truenas-nss/usr/lib/python3/dist-packages target/wheels/truenas_nss-*.whl
	# Remove __pycache__ directories
	find $(CURDIR)/debian/python3-truenas-nss -name "__pycache__" -type d -exec rm -rf {} + || true

override_dh_auto_clean:
	# Clean cargo build artifacts
	cargo clean || true
	rm -rf $(CARGO_HOME)
	# Clean Python build environment
	rm -rf debian/python-build-env

override_dh_python3:
	# Generate Python dependencies
	dh_python3
